<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления настройками тенантов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .form-label { font-weight: bold; }
        textarea { font-family: monospace; }
        .last-modified { font-size: 0.8em; color: grey; margin-top: -10px; margin-bottom: 10px; }
        .status-message { margin-top: 15px; }
        /* Стили для чата */
        #chatArea {
            height: 400px; 
            overflow-y: scroll; 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Настройки тенантов и Тестовый Чат</h1>

        <div class="mb-3">
            <label for="tenantIdInput" class="form-label">ID Тенанта:</label>
            <input type="text" class="form-control" id="tenantIdInput" placeholder="Введите ID тенанта (например, my_clinic)">
            <button type="button" class="btn btn-secondary btn-sm mt-2" id="loadSettingsButton">Загрузить/Проверить настройки</button>
        </div>

        <div id="settingsForm">
            <div class="mb-3">
                <label for="promptAddition" class="form-label">Дополнение к системному промпту:</label>
                <div class="last-modified" id="promptAdditionLastModified"></div>
                <textarea class="form-control" id="promptAddition" rows="6"></textarea>
            </div>

            <!-- Новые поля для информации о клинике -->
            <div class="mb-3">
                <label for="clinicInfoAbout" class="form-label">О клинике (общая информация):</label>
                 <div class="last-modified" id="clinicInfoAboutLastModified"></div>
                <textarea class="form-control" id="clinicInfoAbout" rows="4"></textarea>
            </div>
            <div class="mb-3">
                <label for="clinicInfoHours" class="form-label">Часы работы:</label>
                <textarea class="form-control" id="clinicInfoHours" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="clinicInfoContacts" class="form-label">Контактная информация (адрес, телефон и т.п.):</label>
                <textarea class="form-control" id="clinicInfoContacts" rows="3"></textarea>
            </div>
            <!-- Конец новых полей -->

            <button type="button" class="btn btn-primary" id="saveButton">Сохранить настройки</button>
            <div id="statusMessage" class="status-message"></div>
        </div>

        <hr class="my-4"> <!-- Разделитель -->

        <!-- +++ Секция чата +++ -->
        <h2>Чат для тестирования</h2>
        <div id="chatArea">
            <!-- Сообщения будут добавляться сюда -->
        </div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Введите сообщение..." id="chatInput" aria-label="Сообщение">
            <button class="btn btn-success" type="button" id="sendChatButton">Отправить</button>
            <button class="btn btn-warning" type="button" id="resetChatButton">Сбросить диалог</button>
        </div>
        <div id="chatStatus" class="status-message"></div>
        <!-- +++ Конец секции чата +++ -->

    </div>

    <script>
        // --- Переменные для настроек ---
        const tenantIdInput = document.getElementById('tenantIdInput');
        const loadSettingsButton = document.getElementById('loadSettingsButton');
        const settingsForm = document.getElementById('settingsForm');
        const promptAdditionTextarea = document.getElementById('promptAddition');
        const clinicInfoAboutTextarea = document.getElementById('clinicInfoAbout');
        const clinicInfoHoursTextarea = document.getElementById('clinicInfoHours');
        const clinicInfoContactsTextarea = document.getElementById('clinicInfoContacts');
        const saveButton = document.getElementById('saveButton');
        const statusMessage = document.getElementById('statusMessage');
        const promptAdditionLastModified = document.getElementById('promptAdditionLastModified');
        const clinicInfoLastModified = document.getElementById('clinicInfoAboutLastModified');

        // --- Переменные для чата ---
        const chatArea = document.getElementById('chatArea');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const resetChatButton = document.getElementById('resetChatButton');
        const chatStatus = document.getElementById('chatStatus');
        let chatUserId = `admin_user_${Math.random().toString(36).substring(7)}`; // Простой ID для сессии чата

        // --- Функции для настроек ---

        // Загрузка настроек для введенного тенанта
        async function loadTenantSettings() {
            const tenantId = tenantIdInput.value.trim();
            if (!tenantId) {
                 showStatus('Введите ID тенанта', 'warning');
                 return;
            }
            statusMessage.textContent = 'Загрузка настроек...';
            chatArea.innerHTML = '';
            showChatStatus('');

            // Сбрасываем новые поля перед загрузкой
            promptAdditionTextarea.value = '';
            clinicInfoAboutTextarea.value = '';
            clinicInfoHoursTextarea.value = '';
            clinicInfoContactsTextarea.value = '';
            promptAdditionLastModified.textContent = '';
            clinicInfoLastModified.textContent = '';

            try {
                const response = await fetch(`/tenant_settings/${tenantId}`);
                 if (response.status === 404) {
                    promptAdditionTextarea.value = '';
                    clinicInfoAboutTextarea.value = '';
                    clinicInfoHoursTextarea.value = '';
                    clinicInfoContactsTextarea.value = '';
                    promptAdditionLastModified.textContent = 'Настройки не найдены (будут созданы при сохранении)';
                    clinicInfoLastModified.textContent = '';
                    showStatus('Настройки для этого тенанта еще не созданы.', 'info');
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const settings = await response.json();

                promptAdditionTextarea.value = settings.prompt_addition || '';

                // Разбираем clinic_info_docs и заполняем новые поля
                const clinicDocs = settings.clinic_info_docs || [];
                clinicDocs.forEach(doc => {
                    if (doc.metadata && doc.page_content) {
                        switch (doc.metadata.topic) {
                            case 'О клинике':
                                clinicInfoAboutTextarea.value = doc.page_content;
                                break;
                            case 'Часы работы':
                                clinicInfoHoursTextarea.value = doc.page_content;
                                break;
                            case 'Контакты':
                                clinicInfoContactsTextarea.value = doc.page_content;
                                break;
                            // Можно добавить другие case по необходимости
                        }
                    }
                });

                promptAdditionLastModified.textContent = settings.last_modified_general
                    ? `Посл. изм. (общие): ${new Date(settings.last_modified_general).toLocaleString()}`
                    : 'Общие настройки не изменялись';
                 clinicInfoLastModified.textContent = settings.last_modified_clinic_info
                    ? `Посл. изм. (инфо): ${new Date(settings.last_modified_clinic_info).toLocaleString()}`
                     : 'Информация о клинике не изменялась';

                statusMessage.textContent = 'Настройки загружены.';
                statusMessage.className = `status-message alert alert-info`;
            } catch (error) {
                console.error(`Ошибка загрузки настроек для ${tenantId}:`, error);
                promptAdditionTextarea.value = '';
                clinicInfoAboutTextarea.value = '';
                clinicInfoHoursTextarea.value = '';
                clinicInfoContactsTextarea.value = '';
                promptAdditionLastModified.textContent = 'Ошибка загрузки';
                clinicInfoLastModified.textContent = '';
                showStatus(`Ошибка загрузки настроек для ${tenantId}`, 'danger');
            }
        }

        // Сохранение настроек
        async function saveTenantSettings() {
            const tenantId = tenantIdInput.value.trim();
            if (!tenantId) {
                 showStatus('Ошибка: Введите ID тенанта перед сохранением!', 'danger');
                 return;
            }

            // Собираем clinic_info_docs из новых полей
            const clinicInfoDocsArray = [];
            const aboutText = clinicInfoAboutTextarea.value.trim();
            const hoursText = clinicInfoHoursTextarea.value.trim();
            const contactsText = clinicInfoContactsTextarea.value.trim();

            if (aboutText) {
                clinicInfoDocsArray.push({
                    page_content: aboutText,
                    metadata: { source: "tenant_config", type: "general_info", topic: "О клинике" }
                });
            }
            if (hoursText) {
                clinicInfoDocsArray.push({
                    page_content: hoursText,
                    metadata: { source: "tenant_config", type: "schedule", topic: "Часы работы" }
                });
            }
            if (contactsText) {
                clinicInfoDocsArray.push({
                    page_content: contactsText,
                    metadata: { source: "tenant_config", type: "contacts", topic: "Контакты" }
                });
            }

            const settingsToSave = {
                prompt_addition: promptAdditionTextarea.value,
                clinic_info_docs: clinicInfoDocsArray
            };

            showStatus('Сохранение...', 'info');

            try {
                const response = await fetch(`/tenant_settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        settings: settingsToSave
                    }),
                });

                const result = await response.json();
                if (!response.ok) {
                     throw new Error(result.detail || `HTTP error! status: ${response.status}`);
                }
                showStatus(result.message || 'Настройки успешно сохранены!', 'success');
                loadTenantSettings();
            } catch (error) {
                console.error(`Ошибка сохранения настроек для ${tenantId}:`, error);
                showStatus(`Ошибка сохранения: ${error.message}`, 'danger');
            }
        }

        // Отображение статуса настроек
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message alert alert-${type}`;
        }

        // --- Функции для чата ---

        // Добавление сообщения в область чата
        function addChatMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2');
            messageElement.style.wordWrap = 'break-word'; // Перенос длинных слов

            const strong = document.createElement('strong');
            strong.textContent = sender + ": ";
            messageElement.appendChild(strong);
            
            message = message.replace(/\n/g, '<br>');
            const span = document.createElement('span');
            span.innerHTML = message;
            messageElement.appendChild(span);
            chatArea.appendChild(messageElement);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Отправка сообщения ассистенту
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            const tenantId = tenantIdInput.value.trim();

            if (!message) return;
            if (!tenantId) {
                showChatStatus('Ошибка: Сначала введите ID тенанта!', 'danger');
                return;
            }

            addChatMessage('Вы', message);
            chatInput.value = '';
            showChatStatus('Ассистент думает...', 'info');
            sendChatButton.disabled = true;
            resetChatButton.disabled = true;
            chatInput.disabled = true;

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        tenant_id: tenantId,
                        user_id: chatUserId,
                        reset_session: false
                    }),
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.detail || `HTTP error! status: ${response.status}`);
                }
                addChatMessage('Ассистент', result.response);
                showChatStatus('');

            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                addChatMessage('Ошибка', error.message);
                showChatStatus(`Ошибка: ${error.message}`, 'danger');
            } finally {
                sendChatButton.disabled = false;
                resetChatButton.disabled = false;
                chatInput.disabled = false;
                chatInput.focus(); // Вернуть фокус в поле ввода
            }
        }

         // Сброс диалога
        async function resetChat() {
            const tenantId = tenantIdInput.value.trim();
            if (!tenantId) {
                showChatStatus('Ошибка: Сначала введите ID тенанта!', 'danger');
                return;
            }

            showChatStatus('Сброс диалога...', 'warning');
            chatArea.innerHTML = '';
            sendChatButton.disabled = true;
            resetChatButton.disabled = true;

             try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "(сброс сессии)",
                        tenant_id: tenantId,
                        user_id: chatUserId,
                        reset_session: true
                    }),
                });
                 const result = await response.json();
                 if (!response.ok) {
                    throw new Error(result.detail || `HTTP error! status: ${response.status}`);
                }
                showChatStatus('Диалог сброшен.', 'success');
            } catch (error) {
                console.error('Ошибка сброса диалога:', error);
                showChatStatus(`Ошибка сброса: ${error.message}`, 'danger');
            } finally {
                 sendChatButton.disabled = false;
                 resetChatButton.disabled = false;
            }
        }

         // Отображение статуса чата
        function showChatStatus(message, type = 'info') {
            if (!message) {
                 chatStatus.textContent = '';
                 chatStatus.className = 'status-message';
                 return;
            }
            chatStatus.textContent = message;
            chatStatus.className = `status-message alert alert-${type}`;
        }

        // --- Инициализация ---
        loadSettingsButton.addEventListener('click', loadTenantSettings);

        saveButton.addEventListener('click', saveTenantSettings);

        sendChatButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        });
        resetChatButton.addEventListener('click', resetChat);

    </script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 