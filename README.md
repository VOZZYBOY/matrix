# Med YU Med - Виртуальный Ассистент (LangChain + DeepSeek)

## 1. Обзор

Виртуальный ассистент Med YU Med - это AI-помощник, построенный с использованием фреймворка **LangChain**. Он предназначен для ответов на вопросы пользователей об услугах, ценах, специалистах и филиалах клиники Med YU Med.

Ключевые технологии:
- **FastAPI**: Веб-сервер для предоставления API и простого веб-интерфейса.
- **LangChain**: Основной фреймворк для оркестрации языковой модели, RAG и инструментов.
- **DeepSeek**: Используется как основная языковая модель для генерации ответов и вызова инструментов.
- **GigaChat Embeddings**: Модель для создания векторных представлений (эмбеддингов) данных клиники.
- **ChromaDB**: Локальная векторная база данных для реализации RAG (Retrieval-Augmented Generation) - поиска релевантной информации по базе знаний клиники.
- **LangChain Tools (Function Calling)**: Набор Python-функций, которые модель может вызывать для получения конкретной информации из данных клиники (цены, списки и т.д.).

## 2. Архитектура

Приложение состоит из двух основных частей:

1.  **`app.py`**: FastAPI приложение, которое предоставляет HTTP API эндпоинты для взаимодействия с ассистентом, обслуживает статические файлы и HTML-шаблон для веб-интерфейса.
2.  **`matrixai.py`**: Основной модуль, инкапсулирующий логику LangChain-агента. Он инициализирует модели (DeepSeek, GigaChat Embeddings), настраивает векторную базу ChromaDB, определяет инструменты (function calling), управляет историей диалогов и обрабатывает запросы пользователей.
3.  **`clinic_functions.py`**: Вспомогательный модуль, содержащий классы с бизнес-логикой для инструментов (поиск по данным клиники).
4.  **`base/cleaned_data.json`**: JSON-файл, содержащий исходные данные клиники (услуги, цены, врачи, филиалы).
5.  **`chroma_db_clinic_giga/`**: Директория, где ChromaDB хранит созданную векторную базу данных (персистентное хранилище).

## 3. Ключевые компоненты (`matrixai.py`)

- **Инициализация (`initialize_assistant`)**: При старте модуля (и через функцию `initialize_assistant`) происходит настройка:
    - Загрузка учетных данных (DeepSeek API Key, GigaChat Credentials).
    - Инициализация чат-модели `ChatDeepSeek` и модели эмбеддингов `GigaChatEmbeddings`.
    - Загрузка данных из `cleaned_data.json`.
    - Подготовка и загрузка/создание векторной базы **ChromaDB**. При первом запуске или если директория базы данных отсутствует, база создается заново, что может занять некоторое время из-за необходимости векторизации данных через API GigaChat.
    - Определение и привязка инструментов (`@tool`) к модели `ChatDeepSeek`.
- **Обработка запроса (`run_agent_like_chain`)**: Основная логика ответа на запрос пользователя:
    1.  Поиск релевантной информации в **ChromaDB** (RAG-контекст).
    2.  Формирование промпта для **DeepSeek**, включающего системную инструкцию, историю диалога, запрос пользователя и найденный RAG-контекст.
    3.  Вызов модели `ChatDeepSeek`.
    4.  Если модель решает вызвать инструмент: выполнение соответствующей функции из `clinic_functions.py`, получение результата и повторный вызов модели с этим результатом.
    5.  Если модель генерирует финальный ответ: возврат этого ответа пользователю.
- **Управление историей (`RunnableWithMessageHistory`, `get_session_history`, `chat_memory`)**:
    - История диалогов хранится **в памяти** в словаре `chat_memory`, где ключ - `session_id` (генерируется автоматически для новых пользователей или передается в запросе).
    - `RunnableWithMessageHistory` автоматически управляет извлечением и сохранением истории для каждой сессии.
    - **Важно**: Т.к. история хранится в памяти, она будет **утеряна при перезапуске** приложения.
- **Инструменты (Function Calling)**: Модель DeepSeek обучена использовать следующие инструменты для получения точных данных:

    | Инструмент (`@tool` name)                   | Описание                                                                                                  | Обязательные параметры Pydantic | Класс в `clinic_functions.py`                     |
    | :------------------------------------------ | :-------------------------------------------------------------------------------------------------------- | :------------------------------ | :------------------------------------------------ |
    | `find_employees`                          | Поиск сотрудников по ФИО, услуге или филиалу.                                                             | Нет                             | `FindEmployees`                                 |
    | `get_service_price`                       | Получение цены КОНКРЕТНОЙ услуги (опционально в филиале).                                                 | `service_name`                  | `GetServicePrice`                               |
    | `list_filials`                            | Получение списка всех филиалов.                                                                           | Нет                             | `ListFilials`                                   |
    | `get_employee_services`                   | Получение списка услуг КОНКРЕТНОГО сотрудника.                                                            | `employee_name`                 | `GetEmployeeServices`                           |
    | `check_service_in_filial`                 | Проверка наличия КОНКРЕТНОЙ услуги в КОНКРЕТНОМ филиале.                                                   | `service_name`, `filial_name`   | `CheckServiceInFilial`                          |
    | `compare_service_price_in_filials`        | Сравнение цены КОНКРЕТНОЙ услуги в НЕСКОЛЬКИХ (≥2) филиалах.                                               | `service_name`, `filial_names`  | `CompareServicePriceInFilials`                  |
    | `find_service_locations`                  | Поиск всех филиалов, где доступна КОНКРЕТНАЯ услуга.                                                      | `service_name`                  | `FindServiceLocations`                          |
    | `find_specialists_for_service_in_filial`  | Поиск ВСЕХ специалистов в КОНКРЕТНОМ филиале по КОНКРЕТНОЙ услуге ИЛИ категории.                          | `query_term`, `filial_name`     | `FindSpecialistsByServiceOrCategoryAndFilial` |
    | `list_services_in_category`               | Получение списка всех КОНКРЕТНЫХ услуг в указанной КОНКРЕТНОЙ категории.                                    | `category_name`                 | `ListServicesInCategory`                          |
    | `list_services_in_filial`                 | Получение списка ВСЕХ уникальных услуг, доступных в КОНКРЕТНОМ филиале.                                    | `filial_name`                   | `ListServicesInFilial`                          |
    | `find_services_in_price_range`            | Поиск услуг в заданном ценовом диапазоне (опционально с фильтром по категории/филиалу).                   | `min_price`, `max_price`        | `FindServicesInPriceRange`                      |
    | `list_all_categories`                     | Получение списка всех УНИКАЛЬНЫХ категорий услуг.                                                         | Нет                             | `ListAllCategories`                             |

## 4. Настройка и Запуск

### Требования
- Python 3.9+
- Docker (опционально, для запуска в контейнере)
- Учетные данные API DeepSeek и GigaChat

### Установка зависимостей
```bash
# Создайте и активируйте виртуальное окружение (рекомендуется)
# python -m venv venv
# source venv/bin/activate # Linux/macOS
# venv\Scripts\activate # Windows

pip install -r requirements.txt
```

### Конфигурация
1.  **API Ключи**:
    - Установите переменные окружения `DEEPSEEK_API_KEY` и `GIGACHAT_CREDENTIALS`.
    - Или пропишите их в качестве значений по умолчанию в `matrixai.py` (менее безопасно).
2.  **Данные клиники**: Убедитесь, что файл `base/cleaned_data.json` существует и содержит актуальные данные.
3.  **Константы в `matrixai.py`**: При необходимости можно изменить пути к файлу данных (`JSON_DATA_PATH`), директории ChromaDB (`CHROMA_PERSIST_DIR`), или названия используемых моделей (`DEEPSEEK_CHAT_MODEL`, `GIGA_EMBEDDING_MODEL`).

### Запуск

#### Локально (для разработки)
```bash
# Запуск через app.py (uvicorn встроен)
python app.py

# Или напрямую через uvicorn с автоперезагрузкой
uvicorn app:app --host 0.0.0.0 --port 8001 --reload
```
Приложение будет доступно по адресу `http://localhost:8001`.

#### Через Docker
1.  **Сборка образа:**
    ```bash
    docker build -t matrixai-app .
    ```
2.  **Запуск контейнера:**
    ```bash
    # Убедитесь, что передаете API ключи как переменные окружения
    docker run -d \
      -p 8001:8001 \
      -e DEEPSEEK_API_KEY="ВАШ_КЛЮЧ_DEEPSEEK" \
      -e GIGACHAT_CREDENTIALS="ВАШИ_ДАННЫЕ_GIGACHAT" \
      --name matrixai-instance \
      matrixai-app
    ```
    Приложение будет доступно по адресу `http://localhost:8001` (или IP сервера, если порт опубликован).

## 5. API Endpoints (`app.py`)

| Endpoint         | Метод | Описание                                                                 |
| :--------------- | :---- | :----------------------------------------------------------------------- |
| `/`              | GET   | Отображение простого веб-интерфейса (`templates/index.html`)             |
| `/ask`           | POST  | Отправка запроса ассистенту и получение ответа.                          |
| `/reset_session` | POST  | Сброс истории диалога для указанного `user_id`.                          |
| `/health`        | GET   | Проверка состояния API и инициализации ассистента.                      |
| `/logs`          | GET   | Получение последних строк лог-файла API (`api.log`).                     |

### Пример запроса к `/ask`:

```json
{
  "message": "Какие услуги лазерной эпиляции есть в Москва-сити?",
  "user_id": "user_abc123", // Опционально, будет сгенерирован, если отсутствует
  "reset_session": false    // Опционально, по умолчанию false
}
```

### Пример ответа от `/ask`:

```json
{
  "response": "В филиале 'Москва-сити' доступны следующие услуги лазерной эпиляции Soprano Titanium для женщин: Soprano Пальцы для женщин, Soprano Подбородок для женщин, Soprano Верхняя губа для женщин и другие. Хотите узнать цены или кто из специалистов их выполняет?",
  "user_id": "user_abc123"
}
```


## 7. Лицензия

Проект распространяется под MIT License.
