# Clinic Assistant API (Версия 3.3.1 - ReAct Update)

API для многопользовательского (мультитенантного) ИИ-ассистента для клиник, использующего RAG (Retrieval-Augmented Generation), ReAct-подобный цикл и инструменты (Function Calling) для ответов на вопросы пользователей и выполнения задач.

## Описание

Этот проект представляет собой FastAPI-приложение, которое предоставляет API для взаимодействия с ИИ-ассистентом. Ассистент построен на базе LangChain и использует:

-   **OpenAI GPT-4.1** в качестве основной языковой модели (LLM).
-   **GigaChat Embeddings** для создания векторных представлений документов.
-   **ChromaDB** как векторную базу данных для RAG (с отдельными коллекциями для каждого тенанта).
-   **BM25 Retriever** в комбинации с ChromaDB (Ensemble Retriever) для гибридного поиска.
-   **Redis** для хранения истории диалогов (с изоляцией по тенанту и пользователю).
-   **Инструменты (Tools/Functions)** для получения структурированных данных (цены, списки услуг/врачей/филиалов, запись на прием и т.д.) из исходных JSON-данных тенанта и через API клиники.
-   **ReAct-подобный цикл:** Для выполнения многошаговых задач, где LLM может инициировать вызов инструментов, получать результаты и на их основе принимать решение о следующем шаге (вызов других инструментов или генерация ответа).
-   Механизм управления конфигурацией для каждого тенанта (дополнения к промпту, специфичная информация).
-   **Docker и Docker Compose** для упрощения развертывания и управления.

## Возможности

-   **Мультитенантность:** Поддержка нескольких клиник (тенантов) с изолированными данными и конфигурациями.
-   **RAG:** Поиск релевантной информации (описаний услуг, врачей, общей информации) в базе знаний перед генерацией ответа LLM.
-   **Инструменты (Function Calling):** Способность LLM вызывать функции для получения точных данных (цены, списки, проверки наличия, запись на прием) из структурированных JSON-источников тенанта и API.
-   **ReAct-подобный агентский цикл:** Позволяет ассистенту выполнять сложные задачи, требующие нескольких шагов и вызовов инструментов.
-   **Управление историей диалога:** Сохранение и использование истории для поддержания контекста разговора (через Redis).
-   **Управление конфигурацией тенантов:** API для установки/получения специфичных настроек для каждого тенанта.
-   **Базовый UI:** Простой интерфейс для чата и администрирования (доступен по `/`).
-   **Логирование:** Запись событий API и работы агента в файл `api.log` и консоль.
-   **Контейнеризация:** Готовые `Dockerfile` и `docker-compose.yml` для запуска приложения в Docker.

## Архитектура

-   `app.py`: FastAPI приложение, точки входа API, управление зависимостями, базовый UI.
-   `matrixai.py`: Ядро ассистента, инициализация LangChain, RAG, LLM (OpenAI), ReAct-цикл, управление историей, динамическое создание и вызов инструментов.
-   `rag_setup.py`: Инициализация RAG-компонентов (GigaChat Embeddings, ChromaDB, BM25), загрузка и обработка данных из `base/` и `tenant_configs/`.
-   `clinic_functions.py`: Реализация логики для инструментов (функций), вызываемых LLM. Работает с *сырыми* JSON-данными тенанта и вызывает внешние API клиники.
-   `clinic_index.py`: Функции для построения и использования локальных индексов (ID-маппингов) для ускорения поиска сущностей тенанта по имени.
-   `tenant_config_manager.py`: Управление чтением/записью конфигурационных JSON-файлов тенантов (`tenant_configs/`).
-   `redis_history.py`: Реализация кастомного хранилища истории чатов в Redis.
-   `client_data_service.py`: Функции для взаимодействия с API бэкенда клиники (MatrixCRM) для получения данных о клиенте, свободных слотах, записи на прием.
-   `base/`: Директория для хранения JSON-файлов с *основными структурированными данными* для каждого тенанта (например, `base/tenant_id1.json`).
-   `tenant_configs/`: Директория для хранения JSON-файлов с конфигурацией тенантов (например, `prompt_addition`, `clinic_info_docs`). Управляется через API.
-   `templates/`, `static/`: Шаблоны и статические файлы для UI.
-   `Dockerfile`: Инструкции для сборки Docker-образа приложения.
-   `docker-compose.yml`: Конфигурация для запуска приложения и зависимых сервисов (например, Redis) через Docker Compose.
-   `.env`: Файл для хранения переменных окружения (секреты, конфигурации).
-   `requirements.txt`: Список Python-зависимостей.

## Установка и Запуск

### Предварительные требования

-   Python 3.10+
-   Docker и Docker Compose (рекомендуемый способ запуска)
-   Redis сервер (если не используется Docker Compose для Redis, или если Redis находится на отдельном хосте)

### Установка (Локально, без Docker)

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```
2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv .venv # Рекомендуется имя .venv, так как оно уже в .gitignore
    # Linux/macOS
    source .venv/bin/activate
    # Windows
    # .venv\Scripts\activate
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Настройте переменные окружения:**
    Создайте файл `.env` в корневой директории проекта (пример см. ниже) или установите переменные окружения системно.
    ```dotenv
    # --- OpenAI API --- 
    # OPENAI_API_KEY="sk-proj-..." # Используется chat_model в matrixai.py, если не используется другой ключ ниже

    # --- GigaChat API (для эмбеддингов) ---
    # GIGACHAT_CREDENTIALS="<токен_авторизации_GigaChat>" # Захардкожен в matrixai.py, но лучше через env
    # GIGA_EMBEDDING_MODEL="EmbeddingsGigaR"
    # GIGA_SCOPE="GIGACHAT_API_PERS"
    # GIGA_VERIFY_SSL="False"

    # --- Redis --- 
    REDIS_HOST="localhost"
    REDIS_PORT="6379"
    REDIS_DB_HISTORY="0" # Для истории чатов
    REDIS_DB_CELERY="1"  # Если используется Celery для фоновых задач (в данном проекте пока нет)
    REDIS_PASSWORD=""     # Если ваш Redis защищен паролем

    # --- Пути и конфигурация RAG --- 
    JSON_DATA_PATH="base/cleaned_data.json" # Устарело, используется BASE_DATA_DIR
    BASE_DATA_DIR="base"
    CHROMA_PERSIST_DIR="chroma_db_clinic_giga"
    CHUNK_SIZE=1000
    CHUNK_OVERLAP=200
    SEARCH_K=5

    # --- Настройки приложения FastAPI ---
    APP_HOST="0.0.0.0"
    APP_PORT=8001
    APP_LOG_LEVEL="info"

    # --- Настройки модели и ассистента ---
    # DEEPSEEK_API_KEY="sk-..." # Устарело, используется OpenAI
    # DEEPSEEK_CHAT_MODEL="deepseek-chat" # Устарело
    ```
    *Примечание:* Убедитесь, что ваш Redis сервер запущен и доступен по указанным `REDIS_HOST` и `REDIS_PORT` (если не используете Docker Compose).

5.  **Подготовьте данные тенантов:**
    -   Поместите JSON-файлы с основными данными для каждого тенанта в директорию `base/`. Имя файла должно соответствовать `tenant_id` (например, `base/medyumed.2023-04-24.json`).
    -   Структура данных внутри JSON должна соответствовать той, которую ожидают функции в `clinic_functions.py` (например, список словарей с ключами `serviceName`, `employeeFullName`, `filialName`, `price`, `categoryName`, `serviceDescription`, `employeeDescription` и т.д.).

### Запуск приложения (Локально, без Docker)

```bash
uvicorn app:app --reload --host ${APP_HOST:-0.0.0.0} --port ${APP_PORT:-8001}
```

### Запуск приложения (с использованием Docker Compose - Рекомендуется)

1.  **Убедитесь, что Docker и Docker Compose установлены.**
2.  **Настройте переменные окружения в файле `.env`** (см. пункт 4 выше). `docker-compose.yml` будет использовать этот файл.
3.  **Соберите и запустите контейнеры:**
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет образ для FastAPI приложения (если он изменился) и запустит его вместе с сервисом Redis (если он определен в `docker-compose.yml`).

Приложение будет доступно по адресу `http://localhost:8001` (или по порту, указанному в `docker-compose.yml` и `.env`).

## API Эндпоинты

-   `GET /`: Отображает базовый UI для чата и администрирования.
-   `POST /ask`: Основной эндпоинт для отправки сообщений ассистенту. Требует `tenant_id` и `client_api_token`.
-   `POST /tenant_settings`: Установка настроек для тенанта (`prompt_addition`, `clinic_info_docs`).
-   `GET /tenant_settings/{tenant_id}`: Получение настроек для тенанта.
-   `GET /tenants`: Получение списка ID тенантов, для которых найдены конфигурационные файлы.
-   `GET /health`: Проверка состояния API и инициализации агента.
-   `GET /logs`: Получение последних строк лог-файла.
-   `GET /history/{tenant_id}/{user_id}`: Получение истории чата для пользователя.
-   `POST /clear_history`: Очистка истории чата для пользователя (идентифицируется по `tenant_id` и `phone_number`).

## Структура данных в `base/*.json`

Ожидается, что каждый JSON-файл в директории `base/` будет содержать **список словарей**. Каждый словарь представляет собой одну запись, связывающую услугу, сотрудника, филиал и цену (если применимо). Примерные ключи, используемые в `clinic_functions.py` и `clinic_index.py`:

-   `serviceId`, `serviceName`, `serviceDescription`
-   `categoryId`, `categoryName`
-   `employeeId`, `employeeFullName`, `employeeDescription`
-   `filialId`, `filialName`
-   `price`

Наличие и точность этих полей важны для корректной работы инструментов и RAG.

## Конфигурация Тенантов

Настройки, специфичные для тенанта (дополнение к системному промпту LLM, документы с общей информацией `clinic_info_docs`), управляются через эндпоинты `/tenant_settings`. Данные сохраняются в JSON-файлах в директории `tenant_configs/`.

## Лицензия

Проект распространяется под MIT License.
