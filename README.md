# Clinic Assistant API (Версия 3.3.0)

API для многопользовательского (мультитенантного) ИИ-ассистента для клиник, использующего RAG (Retrieval-Augmented Generation) и инструменты (Function Calling) для ответов на вопросы пользователей.

## Описание

Этот проект представляет собой FastAPI-приложение, которое предоставляет API для взаимодействия с ИИ-ассистентом. Ассистент построен на базе LangChain и использует:
-   **DeepSeek** в качестве основной языковой модели (LLM).
-   **GigaChat Embeddings** для создания векторных представлений документов.
-   **ChromaDB** как векторную базу данных для RAG (с отдельными коллекциями для каждого тенанта).
-   **BM25 Retriever** в комбинации с ChromaDB (Ensemble Retriever) для гибридного поиска.
-   **Redis** для хранения истории диалогов (с изоляцией по тенанту и пользователю).
-   **Инструменты (Tools/Functions)** для получения структурированных данных (цены, списки услуг/врачей/филиалов и т.д.) из исходных JSON-данных тенанта.
-   Механизм управления конфигурацией для каждого тенанта (дополнения к промпту, специфичная информация).

## Возможности

-   **Мультитенантность:** Поддержка нескольких клиник (тенантов) с изолированными данными и конфигурациями.
-   **RAG:** Поиск релевантной информации (описаний услуг, врачей, общей информации) в базе знаний перед генерацией ответа LLM.
-   **Инструменты (Function Calling):** Способность LLM вызывать функции для получения точных данных (цены, списки, проверки наличия) из структурированных JSON-источников тенанта.
-   **Управление историей диалога:** Сохранение и использование истории для поддержания контекста разговора (через Redis).
-   **Управление конфигурацией тенантов:** API для установки/получения специфичных настроек для каждого тенанта.
-   **Базовый UI:** Простой интерфейс для чата и администрирования (доступен по `/`).
-   **Логирование:** Запись событий API и работы агента в файл `api.log` и консоль.

## Архитектура

-   `app.py`: FastAPI приложение, точки входа API, управление зависимостями, базовый UI.
-   `matrixai.py`: Ядро ассистента, инициализация LangChain, RAG, LLM, управление историей, динамическое создание и вызов инструментов.
-   `rag_setup.py`: Инициализация RAG-компонентов (GigaChat Embeddings, ChromaDB, BM25), загрузка и обработка данных из `base/` и `tenant_configs/`.
-   `clinic_functions.py`: Реализация логики для инструментов (функций), вызываемых LLM. Работает с *сырыми* JSON-данными тенанта.
-   `tenant_config_manager.py`: Управление чтением/записью конфигурационных JSON-файлов тенантов (`tenant_configs/`).
-   `redis_history.py`: Реализация кастомного хранилища истории чатов в Redis.
-   `base/`: Директория для хранения JSON-файлов с *основными структурированными данными* для каждого тенанта (например, `base/tenant_id1.json`, `base/tenant_id2.json`).
-   `tenant_configs/`: Директория для хранения JSON-файлов с конфигурацией тенантов (например, `prompt_addition`, `clinic_info_docs`). Управляется через API.
-   `templates/`, `static/`: Шаблоны и статические файлы для UI.

## Установка и Запуск

### Предварительные требования

-   Python 3.10+
-   Redis сервер (запущенный и доступный)

### Установка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```
2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    # Linux/macOS
    source venv/bin/activate
    # Windows
    # venv\Scripts\activate
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Настройте переменные окружения:**
    Создайте файл `.env` в корневой директории проекта или установите переменные окружения системно. Обязательные переменные:
    ```dotenv
    DEEPSEEK_API_KEY="sk-..." # Ваш API ключ DeepSeek
    # GIGACHAT_CREDENTIALS="<ваш_токен>" # В текущей версии захардкожено, но лучше через env
    REDIS_HOST="localhost" # Хост вашего Redis сервера
    REDIS_PORT="6379"      # Порт вашего Redis сервера
    REDIS_DB="0"           # Номер базы данных Redis для истории чатов
    # Необязательные переменные (имеют значения по умолчанию):
    # JSON_DATA_PATH="base/cleaned_data.json" # Путь к *одному* файлу, если используется старый подход
    # BASE_DATA_DIR="base"                  # Директория с JSON файлами тенантов (base/tenant_id.json) - РЕКОМЕНДУЕТСЯ
    # CHROMA_PERSIST_DIR="chroma_db_clinic_giga" # Директория для хранения базы ChromaDB
    # GIGA_EMBEDDING_MODEL="EmbeddingsGigaR"
    # GIGA_SCOPE="GIGACHAT_API_PERS"
    # GIGA_VERIFY_SSL="False"
    # DEEPSEEK_CHAT_MODEL="deepseek-chat"
    # CHUNK_SIZE=1000
    # CHUNK_OVERLAP=200
    # SEARCH_K=5
    # APP_HOST="0.0.0.0"
    # APP_PORT=8001
    # APP_LOG_LEVEL="info"
    ```
    *Примечание:* Убедитесь, что ваш Redis сервер запущен и доступен по указанным `REDIS_HOST` и `REDIS_PORT`.

5.  **Подготовьте данные тенантов:**
    -   Поместите JSON-файлы с основными данными для каждого тенанта в директорию `base/`. Имя файла должно соответствовать `tenant_id` (например, `base/medyumed.2023-04-24.json`).
    -   Структура данных внутри JSON должна соответствовать той, которую ожидают функции в `clinic_functions.py` (например, список словарей с ключами `serviceName`, `employeeFullName`, `filialName`, `price`, `categoryName`, `serviceDescription`, `employeeDescription` и т.д.).

### Запуск приложения

```bash
uvicorn app:app --reload --host 0.0.0.0 --port 8001
```

Приложение будет доступно по адресу `http://localhost:8001` (или по указанному вами хосту/порту). При первом запуске (или если директория ChromaDB пуста/удалена) произойдет индексация данных из `base/` в ChromaDB.

## API Эндпоинты

-   `GET /`: Отображает базовый UI для чата и администрирования.
-   `POST /ask`: Основной эндпоинт для отправки сообщений ассистенту. Требует `tenant_id`.
-   `POST /tenant_settings`: Установка настроек для тенанта (`prompt_addition`, `clinic_info_docs`).
-   `GET /tenant_settings/{tenant_id}`: Получение настроек для тенанта.
-   `GET /tenants`: Получение списка ID тенантов, для которых найдены конфигурационные файлы.
-   `GET /health`: Проверка состояния API и инициализации агента.
-   `GET /logs`: Получение последних строк лог-файла.

## Структура данных в `base/*.json`

Ожидается, что каждый JSON-файл в директории `base/` будет содержать **список словарей**. Каждый словарь представляет собой одну запись, связывающую услугу, сотрудника, филиал и цену (если применимо). Примерные ключи, используемые в `clinic_functions.py`:

-   `serviceId`, `serviceName`, `serviceDescription`
-   `categoryId`, `categoryName`
-   `employeeId`, `employeeFullName`, `employeeDescription`
-   `filialId`, `filialName`
-   `price`

Наличие и точность этих полей важны для корректной работы инструментов.

## Конфигурация Тенантов

Настройки, специфичные для тенанта (дополнение к системному промпту LLM, документы с общей информацией `clinic_info_docs`), управляются через эндпоинты `/tenant_settings`. Данные сохраняются в JSON-файлах в директории `tenant_configs/`.

## 7. Лицензия

Проект распространяется под MIT License.
